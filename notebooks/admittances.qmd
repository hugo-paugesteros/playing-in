---
title: Admittances plots
jupyter: python3
---

```{python}
%matplotlib ipympl
import pathlib
import numpy as np
import scipy
import matplotlib as mpl
import matplotlib.pyplot as plt
import xarray as xr
import shutil
import seaborn as sns
```

```{python}
DATA_DIR = pathlib.Path("../data/_raw/CNSM/")
SR = 51200
N_FFT = 32768
CALIBRATION_X = 1 / (20.41 / 1000)  # mv/N
CALIBRATION_Y = 125 / 1000  # mm/S / V

sessions = [1, 3]
violins = ["Klimke", "Levaggi", "Stoppani"]


def process_file(filepath):
    try:
        mat = scipy.io.loadmat(filepath)
    except Exception as e:
        print(f"Error loading {filepath}: {e}")
        return None

    sr = mat["freq"][0, 0]
    n_fft = mat["npts"][0, 0]

    if n_fft != N_FFT or sr != SR:
        return None

    X_raw = mat["yspec"][:, 1]
    Y_raw = mat["yspec"][:, 0]

    X_cal = X_raw * CALIBRATION_X
    Y_cal = Y_raw * CALIBRATION_Y

    f = np.linspace(0, sr // 2, n_fft // 2 + 1).astype(np.float32)

    H_linear = np.abs(Y_cal / X_cal).astype(np.float32)
    H_db = 20 * np.log10(H_linear)

    ds = xr.Dataset(
        data_vars={
            "H_db": (["frequency"], H_db),
        },
        coords={
            "frequency": f,
            "violin": violin,
            "session": session,
            "filename": filepath.name,
        },
    )

    return ds.expand_dims("measurement")


dataset = []
for session in sessions:
    for violin in violins:
        path = DATA_DIR / f"Session {session}" / "Admittances"
        file_paths = path.glob(f"*{violin}*.mat")
        for i, file_path in enumerate(file_paths):
            ds_entry = process_file(file_path)
            if ds_entry is not None:
                dst = f"../data/raw/phase_{session}/{violin.lower()}/admittances/measurement_{i + 1}.mat"
                os.makedirs(os.path.dirname(dst), exist_ok=True)
                shutil.copy(file_path, dst)
                dataset.append(ds_entry)

dataset = xr.concat(dataset, dim="measurement", coords="different")
dataset.to_netcdf("../data/processed/admittances.nc")
dataset
```



```{python}
dataset = xr.open_dataset("../data/processed/admittances.nc")

H_lin = 10 ** (dataset["H_db"] / 20)
mean = (H_lin**2).groupby(["violin", "session"]).mean(dim="measurement") ** (1 / 2)
mean = 20 * np.log10(mean)
std = dataset["H_db"].groupby(["violin", "session"]).std(dim="measurement")

mpl.style.use("/home/hugo/Thèse/common/styles.mplstyle")
grid = mean.plot.line(
    x="frequency",
    row="violin",
    hue="session",
    figsize=(5, 5),
    sharex=True,
    xscale="log",
    xlim=[200, 5000],
    ylim=[-50, -10],
)

for ax, (violin, sub_da) in zip(grid.axs.flat, mean.groupby("violin")):
    title_suffix = "(Test)" if violin == "Klimke" else "(Control)"
    ax.set_title(f"{violin} {title_suffix}")
    for session in [1, 3]:
        m = mean.sel(violin=violin, session=session)
        s = std.sel(violin=violin, session=session)

        ax.fill_between(m.frequency, m - s, m + s, alpha=0.2)

grid.figlegend.set_title("Session")
grid.set_axis_labels("Frequency (Hz)", "Amplitude (dB)")
plt.savefig("../reports/figures/admittances.png")
plt.savefig("../reports/figures/admittances.svg")
plt.show()
```


```{python}
dataset = xr.open_dataset("../data/processed/admittances.nc")

H_lin = 10 ** (dataset["H_db"] / 20)
mean = (H_lin**2).groupby(["violin", "session"]).mean(dim="measurement") ** (1 / 2)
mean = 20 * np.log10(mean)
diff = mean.sel(session=1) - mean.sel(session=3)
std = dataset["H_db"].groupby(["violin", "session"]).std(dim="measurement")

mpl.style.use("/home/hugo/Thèse/common/styles.mplstyle")

violins = mean.violin.values
n_violins = len(violins)

mm = 1 / (2.54 * 10)

fig, axs = plt.subplots(
    nrows=n_violins + 1,
    ncols=1,
    sharex=True,
    figsize=(140 * mm, 200 * mm),
)

colors = {
    1: "tab:gray",
    3: "tab:red",
    "Klimke": "C0",
    "Levaggi": "C1",
    "Stoppani": "C2",
}

for i, violin in enumerate(violins):
    ax = axs[i]

    # Title logic
    title_suffix = "(Test)" if violin == "Klimke" else "(Control)"
    ax.set_title(f"{violin} {title_suffix}")

    # Loop over sessions manually
    for phase, session in zip([1, 2], [1, 3]):
        # Select data
        m = mean.sel(violin=violin, session=session)
        s = std.sel(violin=violin, session=session)
        ind = dataset.where(
            (dataset.violin == violin) & (dataset.session == session),
            drop=True,
        )
        ind = ind["H_db"].T

        # Plot Mean
        ax.plot(
            m.frequency,
            m,
            label=f"Phase {phase}",
            c=colors[session],
        )

        # Plot individual
        # ax.plot(dataset.frequency, ind, c=colors[session], alpha=0.2)

        # Plot Variability (Fill)
        ax.fill_between(
            m.frequency,
            ind.min("measurement"),
            ind.max("measurement"),
            alpha=0.2,
            color=colors[session],
            # label="Range (min-max)",
        )

    axs[-1].plot(
        diff.frequency,
        diff.sel(violin=violin),
        label=violin,
        c=colors[violin],
    )

for ax in axs:
    ax.set_xscale("log")
    ax.set_xlim([180, 5000])
    ax.set_ylim([-45, 0])
    ax.grid(True, which="both", alpha=0.3)
    ax.set_xlabel("Frequency (Hz)")
    ax.set_ylabel("Amplitude (dB)")
    ax.xaxis.set_ticks([200, 500, 1000, 5000])
    ax.get_xaxis().set_major_formatter(mpl.ticker.ScalarFormatter())
    ax.legend(
        fontsize="small",
        loc="upper left",
        mode="expand",
        ncol=4,
    )

axs[-1].set_title("Differences between phase 1 and phase 2")
axs[-1].set_ylim([-20, 25])
axs[-1].legend(
    fontsize="small",
    loc="upper left",
    mode="expand",
    ncol=3,
)

plt.savefig("../reports/figures/admittances.png")
plt.savefig("../reports/figures/admittances.svg")
plt.show()
```

```{python}
dataset = xr.open_dataset("../data/processed/admittances.nc")

# 1. Convert to DataFrame
df = dataset["H_db"].sel(frequency=slice(200, 5000)).to_dataframe().reset_index()

# Load your style
mpl.style.use("/home/hugo/Thèse/common/styles.mplstyle")

# 2. Plot all measurements
# units="measurement" separates the lines
sns.color_palette("tab10")
grid = sns.relplot(
    data=df,
    x="frequency",
    y="H_db",
    row="violin",
    hue="session",
    units="measurement",
    estimator=None,
    kind="line",
    height=5 / 3,
    aspect=3,
    facet_kws={"sharex": True, "sharey": False},
    palette=sns.color_palette("tab10"),
    alpha=0.8,
)
grid.legend.set_title("Session")
grid.set_axis_labels("Frequency (Hz)", "Amplitude (dB)")

# 3. Apply scales and limits
grid.set(xscale="log", xlim=[200, 5000], ylim=[-50, -10])
```

## Euclidean distances between admittances

```{python}
print(f"{'Violin':<10} | {'Euclidean Distance':<15}")
print("-" * 30)
freq_mask = slice(190, 5000)
for violin in ["Klimke", "Levaggi", "Stoppani"]:
    before = mean.sel(violin=violin, session=1, frequency=freq_mask)
    after = mean.sel(violin=violin, session=3, frequency=freq_mask)
    dist = np.linalg.norm(after - before)
    print(f"{violin:<10} | {dist:.4f}")
```

