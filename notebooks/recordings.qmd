---
jupyter: python3
title: LTAS plots
---

```{python}
%matplotlib ipympl
import pandas as pd
import numpy as np
import matplotlib as mpl
import matplotlib.pyplot as plt
import xarray as xr
import soundfile as sf
import librosa

import identification.dataset
```

```{python}
config = {
    "frame_size": 2048,
    "hop_ratio": 4,
    "n_coeff": 40,
    "sr": 16000,
    "sample_duration": 60,
    "feature": "LTAS_welch_db",
}


data = pd.read_pickle("/home/hugo/Thèse/identification/data/processed/dataset_cnsm.pkl")
data = data[(data.violin.isin(["A", "B", "C"]))]
data = data[data.session.isin([1, 3])]
data = data[data.extract == "gamme"]
data.violin = data.violin.map({"A": "Klimke", "B": "Levaggi", "C": "Stoppani"})

for row in data.itertuples():
    y, sr = librosa.load(
        row.file,
        sr=None,
        offset=row.start,
        duration=row.end - row.start,
    )
    y = (y * 32767).astype(np.int16)
    dst = f"../data/raw/phase_{row.session}/{row.violin.lower()}/recordings/{row.extract}-{row[0]}.flac"
    os.makedirs(os.path.dirname(dst), exist_ok=True)
    sf.write(dst, y, sr)

df = identification.dataset.get_dataset(config, data)
```

```{python}
feature_matrix = np.stack(df["features"].values)
n_features = feature_matrix.shape[1]
f = np.linspace(0, config["sr"] // 2, n_features)

ds = xr.Dataset(
    data_vars={
        "features": (["measurement", "frequency"], feature_matrix),
    },
    coords={
        "measurement": df.index,
        "frequency": f,
        "violin": (["measurement"], df["violin"]),
        "condition": (["measurement"], df["condition"]),
        "player": (["measurement"], df["player"]),
        "session": (["measurement"], df["session"]),
        "extract": (["measurement"], df["extract"]),
        "start_time": (["measurement"], df["start"]),
        "end_time": (["measurement"], df["end"]),
        "filepath": (["measurement"], df["file"]),
    },
)
ds.to_netcdf("../data/processed/recordings.nc")
ds
```

```{python}
mpl.style.use("/home/hugo/Thèse/common/styles.mplstyle")

mean = ds["features"].groupby(["violin", "session"]).mean(dim="measurement")
std = ds["features"].groupby(["violin", "session"]).std(dim="measurement")

grid = mean.plot.line(
    x="frequency",
    row="violin",
    hue="session",
    figsize=(5, 5),
    sharex=True,
    xscale="log",
    xlim=[200, 5000],
    ylim=[-80, -10],
)

for ax, (violin, sub_da) in zip(grid.axs.flat, mean.groupby("violin")):
    title_suffix = "(Test)" if violin == "Klimke" else "(Control)"
    ax.set_title(f"{violin} {title_suffix}")
    for session in [1, 3]:
        m = mean.sel(violin=violin, session=session)
        s = std.sel(violin=violin, session=session)

        ax.fill_between(m.frequency, m - s, m + s, alpha=0.2)
grid.set_axis_labels("Frequency (Hz)", "Amplitude (dB)")
plt.savefig("../reports/figures/ltas.png")
plt.show()
```

```{python}
print(f"{'Violin':<10} | {'Euclidean Distance':<15}")
print("-" * 30)
freq_mask = slice(190, 5000)
for violin in ["Klimke", "Levaggi", "Stoppani"]:
    before = mean.sel(violin=violin, session=1, frequency=freq_mask)
    after = mean.sel(violin=violin, session=3, frequency=freq_mask)
    dist = np.linalg.norm(after - before)
    print(f"{violin:<10} | {dist:.4f}")
```

